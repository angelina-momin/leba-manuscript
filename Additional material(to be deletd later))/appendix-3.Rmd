
```{r MinRes, include=F}
library(psych)
library(tabledown)
library(kableExtra)#without this pdf rendering will not happen

data <- readRDS("leba_2021-09-08.rds")

# Separating EFA and CFA samples with descriptive column
descriptives.data <- data

## Merge "0"s and "1"s into "1"s select,subset assign)
descriptives.data[ , 9:56 ][ descriptives.data[ , 9:56 ] == 0 ] <- 1
#EFA.descriptives <- descriptives.data[1:428,]
EFA.descriptives <- subset(descriptives.data, IncludedInEFA == "TRUE")
#CFA.descriptives <- descriptives.data[429:690, ]
CFA.descriptives<- subset(descriptives.data, IncludedInEFA == "FALSE")

#Separating the EFA and CFA(only items)
sem.data <- data[, 9:56] #EFA & CFA data
sem.data[ sem.data == 0] <- 1 #Merged "0"s and "1"s into "1"s

## renaming the column-header
prefix <- "item"
sufix <- c(1:48)
colnam <- paste(prefix,sufix, sep = "" )
colnames(sem.data) <- colnam

names(sem.data)[names(sem.data) == "item1"] <- "item01"
names(sem.data)[names(sem.data) == "item2"] <- "item02"
names(sem.data)[names(sem.data) == "item3"] <- "item03"
names(sem.data)[names(sem.data) == "item4"] <- "item04"
names(sem.data)[names(sem.data) == "item5"] <- "item05"
names(sem.data)[names(sem.data) == "item6"] <- "item06"
names(sem.data)[names(sem.data) == "item7"] <- "item07"
names(sem.data)[names(sem.data) == "item8"] <- "item08"
names(sem.data)[names(sem.data) == "item9"] <- "item09"

### EFA data
EFA.data <- sem.data[1:428, ]
#Polychoric Correlation matrix

correlations <- psych::polychoric(EFA.data, correct = 0)

#Supplementary EFA with Minres Extraction

fa.5F.min.1 <- fa(r=correlations$rho, nfactors = 5, fm= "minres",rotate ="varimax",
                residuals = TRUE, SMC = TRUE, n.obs =428)
EE <- print(fa.5F.min.1, cut = .3, digits = 3, sort = TRUE)


reduced.model.5F.min.1 <- dplyr::select(EFA.data ,
                                    -c( item20, item19, item05, item31, item44, item24, item43, item39, item22, item02, item18, item48, item42, item29, item06, item15, item23, item28, item14))

correlations.red.5F.min.1 <- polychoric(reduced.model.5F.min.1,correct = 0)

fa.5F.min.2 <- fa(r=correlations.red.5F.min.1$rho, nfactors = 5, fm= "minres",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)

FF <- print(fa.5F.min.2, cut = .3, digits = 3, sort = TRUE)

reduced.model.5F.min.2 <- dplyr::select(EFA.data, -c( item20, item19, item05, item31, item44, item24, item43, item39, item22, item02, item18, item48, item42, item29, item06, item15, item23, item28, item14, item34, item47, item21, item13))

correlations.red.5F.min.2 <- polychoric(reduced.model.5F.min.2, correct = 0)


fa.5F.min.3 <- fa(r=correlations.red.5F.min.2$rho, nfactors = 5, fm= "minres",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)

GG <- print(fa.5F.min.3, cut = .3, digits = 3, sort = TRUE)

minresTab <- tabledown::fac.tab(fa.5F.min.3, cut =.3,complexity = F)
```

```{r MinResTab}
papaja::apa_table(minresTab,  caption = "Factor loadings and communality of the retained items (Minmum Residual)", note = "Only loading higher than .30 is reported", longtable=T, font_size = "small")
```


# Factor analysis with six factors

```{r sixFac, include=F}
# EFA with 6 factor (rejected)


#correlations <- polychoric(EFA.factor, correct = 0)

fa.6F.1 <- fa(r=correlations$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)

II <- print(fa.6F.1, cut = .3, digits = 3, sort = TRUE)


reduced.model.6F.1 <- dplyr::select(EFA.data ,
                                    -c(item34, item44, item48, item43, item39, item22, item02, item20, item21, item24,item30, item14, item28, item06, item15, item23))

correlations.red.6F.1 <- polychoric(reduced.model.6F.1,correct = 0)

fa.6F.2 <- fa(r=correlations.red.6F.1$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)

JJ <- print(fa.6F.2, cut = .3, digits = 3, sort = TRUE)

reduced.model.6F.2 <- dplyr::select(EFA.data, -c(item34, item44, item48, item43, item39, item22, item02, item20, item21, item24,item30, item14, item28, item06, item15, item23, item18, item42, item47, item41))

correlations.red.6F.2 <- polychoric(reduced.model.6F.2,correct = 0)


fa.6F.3 <- fa(r=correlations.red.6F.2$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428, max.iter = 500)

KK <- print(fa.6F.3, cut = .3, digits = 3, sort = TRUE)



reduced.model.6F.3 <- dplyr::select(EFA.data, -c(item34, item44, item48, item43, item39, item22, item02, item20, item21, item24,item30, item14, item28, item06, item15, item23, item18, item42, item47, item41, item05, item13, item29))

correlations.red.6F.3 <- polychoric(reduced.model.6F.3,correct = 0)


fa.6F.4 <- fa(r=correlations.red.6F.3$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428, max.iter = 500)

ll <- print(fa.6F.4, cut = .3, digits = 3, sort = TRUE)


reduced.model.6F.4 <- dplyr::select(EFA.data, -c(item34, item44, item48, item43, item39, item22, item02, item20, item21, item24,item30, item14, item28, item06, item15, item23, item18, item42, item47, item41, item05, item13, item29, item19))

correlations.red.6F.4 <- polychoric(reduced.model.6F.4,correct = 0)


fa.6F.5 <- fa(r=correlations.red.6F.4$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428, max.iter = 500)

mm <- print(fa.6F.5, cut = .3, digits = 3, sort = TRUE)



# Residuals
residual.6F =residuals(fa.6F.5 , diag = FALSE, na.rm =T)
#Count of numbers of residuals>.05
BigRRR= sum(residual.6F>abs(.05), na.rm =T)
print(BigRRR)

#Total number of off diagonal elements in the data matrix
totRRR = length(reduced.model.6F.2)*(length(reduced.model.6F.2)-1)/2

# Proportion of off-diagonal elements >.10
sumRRR <- sum(BigRRR/totRRR*100)

#hist(residual.6F, main = NULL, xlab = "Six factor Solution: Residuals",ylim=c(0, 400))
#abline(h =65, lwd = 2, lty = 2)
#abline(v =.05,lwd = 2, lty = 2)
sixFac <- tabledown::fac.tab(fa.6F.5, cut =.3,complexity = F)
```

```{r sixFacTab, results='asis'}
papaja::apa_table(sixFac,  caption = "Factor loadings and communality of the retained items(six factor)", note = "Only loading higher than .30 is reported; Sixth factor has only two salient loadings",longtable =T, font_size = "small")
```



```{r DataAppB, include=FALSE}
data <- readRDS("leba_2021-09-08.rds")


#Separating the EFA and CFA(only items)
sem.data <- data[, 9:56] #EFA & CFA data
## renaming the column-header
prefix <- "item"
sufix <- c(1:48)
colnam <- paste(prefix,sufix, sep = "" )
colnames(sem.data) <- colnam
names(sem.data)[names(sem.data) == "item1"] <- "item01"
names(sem.data)[names(sem.data) == "item2"] <- "item02"
names(sem.data)[names(sem.data) == "item3"] <- "item03"
names(sem.data)[names(sem.data) == "item4"] <- "item04"
names(sem.data)[names(sem.data) == "item5"] <- "item05"
names(sem.data)[names(sem.data) == "item6"] <- "item06"
names(sem.data)[names(sem.data) == "item7"] <- "item07"
names(sem.data)[names(sem.data) == "item8"] <- "item08"
names(sem.data)[names(sem.data) == "item9"] <- "item09"
EFA.data <- sem.data[1:428, ]

correlations <- psych::polychoric(EFA.data, correct = 0)

```


```{r ggplot2AppB, include=F}
apatheme=ggplot2::theme_bw()+
  ggplot2::theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        #text=element_text(family = "Helvetica",),
        legend.title=element_blank(),
        axis.line.x = element_line(color='black'),
        axis.line.y = element_line(color='black'),
        panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 1))
```



```{r EFAAppB, include=FALSE}
fa.5F.1 <- fa(r=correlations$rho, nfactors = 5, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)
AA <- print(fa.5F.1, cut = .3, digits = 3, sort = TRUE)


reduced.model.5F.1 <- dplyr::select(EFA.data ,
                                    -c(item32, item34, item24, item37, item22, item05,
                                        item28, item30, item39,item23, item45, item06, item29, item02, item41))

correlations.red.5F.1 <- polychoric(reduced.model.5F.1,correct = 0)

fa.5F.2 <- fa(r=correlations.red.5F.1$rho, nfactors = 5, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)

BB <- print(fa.5F.2, cut = .3, digits = 3, sort = TRUE)

reduced.model.5F.2 <- dplyr::select(EFA.data, -c( item32, item34, item24, item37, item22, item05,
                                        item28, item30, item39,item23, item45, item06, item29, item02, item41, item46, item13, item15, item25, item01, item26, item14))

correlations.red.5F.2 <- polychoric(reduced.model.5F.2,correct = 0)


fa.5F.3 <- fa(r=correlations.red.5F.2$rho, nfactors = 5, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428,max.iter = 500 )

CC <- print(fa.5F.3, cut = .3, digits = 3, sort = TRUE)

reduced.model.5F.3 <- dplyr::select(EFA.data, -c( item32, item34, item24, item37, item22, item05,
                                        item28, item30, item39,item23, item45, item06, item29, item02, item41, item46, item13, item15, item25, item01, item26, item14, item43, item42))

correlations.red.5F.3 <- polychoric(reduced.model.5F.3,correct = 0)


fa.5F.4 <- fa(r=correlations.red.5F.3$rho, nfactors = 5, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428,max.iter = 500 )

CC <- print(fa.5F.4, cut = .3, digits = 3, sort = TRUE)
```

```{r factordetailsAppB, include=FALSE}
#Preparing the EFA table
efa.table <- tabledown::fac.tab(fa.5F.4,.3, complexity = F) 
```

```{r efaunmerged, results='asis'}
apa_table(efa.table, caption = "Factor loadings and communality of the retained items in five factor solution [Unmerged Responses]", note = "Only loading higher than .30 is reported", longtable =T, font_size = "small")
```


```{r EFAAppsix, include=FALSE, warning=F,message=FALSE}

library(Hmisc)
fa.6F.1 <- fa(r=correlations$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)
DD <- print(fa.6F.1, cut = .3, digits = 3, sort = TRUE)

reduced.model.6F.1 <- dplyr::select(EFA.data ,
                                    -c(item32, item34, item44,item24, item37, item22, item05,
                                        item28,item39,item23, item45, item06, item29, item02, item41, item30))

correlations.red.6F.2 <- polychoric(reduced.model.6F.1,correct = 0)

fa.6F.2 <- fa(r=correlations.red.6F.2$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)

EE <- print(fa.6F.2, cut = .3, digits = 3, sort = TRUE)
reduced.model.6F.2 <- dplyr::select(EFA.data ,
                                    -c(item32, item34, item44,item24, item37, item22, item05,
                                        item28,item39,item23, item45, item06, item29, item02, item41, item30, item46, item36,item01, item25))
correlations.red.6F.3 <- polychoric(reduced.model.6F.2,correct = 0)
fa.6F.3 <- fa(r=correlations.red.6F.3$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)
FF <- print(fa.6F.3, cut = .3, digits = 3, sort = TRUE)

reduced.model.6F.3 <- dplyr::select(EFA.data ,
                                    -c(item32, item34, item44,item24, item37, item22, item05,
                                        item28,item39,item23, item45, item06, item29, item02, item41, item30, item46, item36,item01, item25, item18))
correlations.red.6F.4 <- polychoric(reduced.model.6F.3,correct = 0)
fa.6F.4 <- fa(r=correlations.red.6F.4$rho, nfactors = 6, fm= "pa",rotate ="varimax",
              residuals = TRUE, SMC = TRUE, n.obs =428)
FF <- print(fa.6F.4, cut = .3, digits = 3, sort = TRUE)

efa.table.2 <- tabledown::fac.tab(fa.6F.4,.3, complexity = F) 
```


```{r EFAsix, results='asis'}
apa_table(efa.table.2, caption = "Factor loadings and communality of the retained items in six factor solution [Unmerged Responses]", note = "Only loading higher than .30 is reported", longtable =T, font_size = "small")
```

## Items Retained in the Five Factor Solution [Unmerged Responses]

| **Five Factor Solution [Unmerged Responses] (24 Items)** |
|---------------------------------------------------------|
| **F1**                                                  |
| `r label(sem.data$item19)`                              |
| `r label(sem.data$item20)`                              |
| `r label(sem.data$item18)`                              |
| `r label(sem.data$item21)`                              |
| `r label(sem.data$item4)`                               |
| **F2**                                                  |
| `r label(sem.data$item11)`                              |
| `r label(sem.data$item10)`                              |
| `r label(sem.data$item12)`                              |
| `r label(sem.data$item8)`                               |
| `r label(sem.data$item7)`                               |
| `r label(sem.data$item9)`                               |
| **F3**                                                  |
| `r label(sem.data$item3)`                               |
| `r label(sem.data$item27)`                              |
| `r label(sem.data$item40)`                              |
| **F4**                                                  |
| `r label(sem.data$item35)`                              |
| `r label(sem.data$item48)`                              |
| `r label(sem.data$item33)`                              |
| `r label(sem.data$item47)`                              |
| `r label(sem.data$item44)`                              |
| `r label(sem.data$item31)`                              |
| `r label(sem.data$item38)`                              |
| **F5**                                                  |
| `r label(sem.data$item16)`                              |
| `r label(sem.data$item17)`                              |
| `r label(sem.data$item36)`                              |




```{r Timetab, include=FALSE, warning=F,message=FALSE}
descriptives.data%>%
  tbl_summary(
    label = slypos_demographics_tz.factor ~ "Time zone - Country",
    statistic = list(all_categorical() ~ "{n} ({p}%)"),
    missing = "no",
    sort = all_categorical() ~ "frequency",
    include = "slypos_demographics_tz.factor"
  )  %>% bold_labels() %>% 
  modify_header(label ~ "") %>%
  modify_caption("Geographical Location") -> tz_table

  as_tibble(tz_table, format = 'pipe') -> tz_tibble

as_kable(tz_table, format = "latex",booktabs = T, longtable =T) -> tz_kable

```

```{r tztabprint, results='asis'}

tz_kable %>% 
  kable_styling(latex_options = c("repeat_header")) %>% 
  column_spec(1,width = "10cm") %>% 
  column_spec(2,width = "2cm")
          

```
